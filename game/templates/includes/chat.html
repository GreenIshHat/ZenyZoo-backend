{% comment %} Place this at game/templates/includes/chat.html {% endcomment %}

<style>
.chat-container {
  width: 100%;
  max-width: 600px;
  margin: 1rem auto;
  padding: 1rem;
  background: #1a1a1a;
  border: 1px solid #444;
  border-radius: 8px;
  color: #eee;
}
.chat-title {
  margin-top: 0;
  font-size: 1.25rem;
  border-bottom: 1px solid #444;
  padding-bottom: 0.5rem;
}
.chat-log {
  height: 300px;
  overflow-y: auto;
  background: #111;
  padding: 0.5rem;
  margin: 0.75rem 0;
  border-radius: 4px;
  font-family: monospace;
  line-height: 1.4;
}
.chat-notice {
  text-align: center;
  color: #888;
  margin: 0.5rem 0;
  font-style: italic;
}
.chat-input-group {
  display: flex;
}
.chat-input {
  flex: 1;
  padding: 0.5rem;
  border: 1px solid #444;
  border-radius: 4px 0 0 4px;
  background: #222;
  color: #fff;
}
.chat-send-btn {
  padding: 0 1rem;
  background: #0066cc;
  border: none;
  border-radius: 0 4px 4px 0;
  color: #fff;
  cursor: pointer;
}
.chat-send-btn:hover {
  background: #005bb5;
}
</style>

<div id="global-chat" class="chat-container">
  <h3 class="chat-title">Global Chat</h3>
  <div id="chat-log" class="chat-log"></div>
  <div class="chat-input-group">
    <input id="chat-message-input" class="chat-input"
           type="text" placeholder="Type a message..." />
    <button id="chat-send-btn" class="chat-send-btn">Send</button>
  </div>
</div>

<script>
(function() {
  const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
  const chatSocket = new WebSocket(protocol + window.location.host + '/ws/chat/global/');
  const chatLog    = document.getElementById('chat-log');
  const chatInput  = document.getElementById('chat-message-input');
  const chatSend   = document.getElementById('chat-send-btn');

  chatSocket.onopen = () => console.log('Chat WS connected');
  chatSocket.onerror = err => console.error('Chat WS error:', err);

  chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    let line = '';

    switch (data.event) {
      case 'join':
        line = `<div class="chat-notice"><em>${data.username} joined the chat.</em></div>`;
        break;
      case 'leave':
        line = `<div class="chat-notice"><em>${data.username} left the chat.</em></div>`;
        break;
      case 'message':
      default:
        line = `<div><strong>${data.username}:</strong> ${data.message}</div>`;
    }

    chatLog.insertAdjacentHTML('beforeend', line);
    chatLog.scrollTop = chatLog.scrollHeight;
  };

  chatSocket.onclose = () => {
    chatLog.insertAdjacentHTML('beforeend',
      '<div class="chat-notice"><em>Disconnected from chat.</em></div>');
  };

  chatSend.addEventListener('click', sendChat);
  chatInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') sendChat();
  });

  function sendChat() {
    const msg = chatInput.value.trim();
    if (!msg) return;
    chatSocket.send(JSON.stringify({ message: msg }));
    chatInput.value = '';
  }
})();
</script>
