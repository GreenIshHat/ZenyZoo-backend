{% extends "base.html" %}
{% block title %}Open Matches{% endblock %}

{% block content %}

<h2>Join an Open Match</h2>

<ul id="your-matches">
  {% for m in your_matches %}
    <li id="match-{{m.id}}">
      Match #{{m.id}} – <span class="status">
        {% if m.player_two %}Joined{% else %}Waiting…{% endif %}
      </span>
    </li>
  {% endfor %}
</ul>


  {% if open_matches %}
    <div class="deck not-battle" id="matches-row">
      {% for match in open_matches %}
        <a href="{% url 'battle_view' match.id %}" class="card match-card">
          <div class="card-face" style="padding: 8px; text-align: center;">
            <strong>Match #{{ match.id }}</strong><br>
            Host: {{ match.player_one.user.username }}
          </div>
        </a>
      {% endfor %}
    </div>
  {% else %}
    <p>No open matches. <a href="{% url 'create_open_match' %}">Create one</a> now.</p>
  {% endif %}
{% endblock %}


<script>
const myMatches = Array.from(document.querySelectorAll('#your-matches li'))
  .map(li => +li.id.replace('match-',''));
const notified = {};

setInterval(()=>{
  myMatches.forEach(id=>{
    if (notified[id]) return;
    fetch(`/game/api/match/${id}/`)
      .then(r=>r.json())
      .then(data=>{
        if (data.player_two) {
          alert(`⚡️ Player ${data.player_two} joined Match #${id}!`);
          document.querySelector(`#match-${id} .status`).textContent = 'Joined';
          notified[id] = true;
        }
      });
  });
}, 5000);
</script>