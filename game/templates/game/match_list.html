<!-- templates/game/match_list.html -->
{% extends "base.html" %}
{% load static %}

{% block content %}
<h1>Open Matches</h1>

<ul id="match-list">
  <!-- Matches will be populated here -->
</ul>

<button onclick="createMatch()">Create New Match</button>

<button onclick="battleBot()">Battle Random Bot</button>

<script>
  async function battleBot() {
    const res = await fetch('/game/battle-bot/', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ player_id: playerId })
    });
    const match = await res.json();
    window.location.href = `/game/battle/${match.match_id}/`;
  }
</script>

<script>
  const playerId = {{ request.user.id }};

  async function fetchMatches() {
    const res = await fetch('/game/match/list-open/');
    const matches = await res.json();
    const list = document.getElementById('match-list');
    list.innerHTML = '';

    matches.forEach(match => {
      const li = document.createElement('li');
      li.textContent = `Match ${match.id} by ${match.player_one}`;
      const joinBtn = document.createElement('button');
      joinBtn.textContent = "Join";
      joinBtn.onclick = () => joinMatch(match.id);
      li.appendChild(joinBtn);
      list.appendChild(li);
    });
  }

  async function createMatch() {
    const res = await fetch('/game/match/create/', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ player_id: playerId })
    });
    const match = await res.json();
    window.location.href = `/game/battle/${match.match_id}/`;
  }

  async function joinMatch(matchId) {
    const res = await fetch('/game/match/join/', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ match_id: matchId, player_id: playerId })
    });
    const match = await res.json();
    window.location.href = `/game/battle/${match.match_id}/`;
  }

  fetchMatches();
</script>
{% endblock %}

